// Backend/app.js
require('dotenv').config();
const express = require('express');
const cors = require('cors');

const { connectDB, disconnectDB } = require('./config/database');
const security = require('./middleware/security'); // n·∫øu c√≥, file n√†y t·ª± app.use b√™n trong
const { notFound, errorHandler } = require('./middleware/error-handler'); // <<< s·ª≠a
const apiRoutes = require('./routes/api');

const app = express();
const PORT = process.env.PORT || 4000;
const ORIGIN = process.env.FRONTEND_ORIGIN || 'http://localhost:3000';

// -----------------------------
// 1) MIDDLEWARE CHUNG
// -----------------------------
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// B·∫£o m·∫≠t (helmet, rate-limit...) n·∫øu b·∫°n c√≥ c√†i trong file security.js
if (typeof security === 'function') security(app);

// CORS cho frontend (prod + preview vercel + local)
app.use(
  cors({
    origin: [ORIGIN, 'http://localhost:3000', /\.vercel\.app$/],
    credentials: true,
    allowedHeaders: ['Content-Type', 'Authorization'],
    methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],
  })
);

// -----------------------------
// 2) ROUTES
// -----------------------------
app.use('/api', apiRoutes);

// Healthcheck
const healthHandler = (_req, res) =>
  res.status(200).json({
    ok: true,
    service: 'Backend API',
    env: process.env.NODE_ENV || 'development',
  });

app.get('/healthz', healthHandler);
app.get('/api/health', healthHandler); // th√™m ƒë·ªÉ kh·ªõp Render

// -----------------------------
// 3) ERROR HANDLERS (ƒë·∫∑t CU·ªêI C√ôNG)
// -----------------------------
app.use(notFound);       // 404
app.use(errorHandler);   // 500 (4 tham s·ªë)

// -----------------------------
// 4) BOOT & SHUTDOWN
// -----------------------------
let server;

connectDB()
  .then(() => {
    server = app.listen(PORT, () => {
      console.log(`üöÄ Backend listening on http://localhost:${PORT}`);
      console.log(`ü©∫ Healthcheck: GET http://localhost:${PORT}/healthz`);
      console.log(`üåê CORS origin: ${ORIGIN}`);
    });
  })
  .catch((err) => {
    console.error('‚ùå K·∫øt n·ªëi Database th·∫•t b·∫°i. Tho√°t ·ª©ng d·ª•ng.', err);
    process.exit(1);
  });

async function shutdown(signal) {
  try {
    console.log(`\nüì¥ Received ${signal}. Closing server...`);
    if (server) await new Promise((r) => server.close(r));
    await disconnectDB();
    console.log('‚úÖ Clean shutdown complete.');
    process.exit(0);
  } catch (e) {
    console.error('‚ö†Ô∏è Error during shutdown:', e);
    process.exit(1);
  }
}
process.on('SIGINT', () => shutdown('SIGINT'));
process.on('SIGTERM', () => shutdown('SIGTERM'));

module.exports = app;
